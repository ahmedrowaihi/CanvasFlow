let errorCodes=new Map([[100,"Missing props. Objects requires a 'id' property."],[101,"Invalid argument. Argument must be an object."],[102,"Invalid argument. Argument must be an array of objects."],[103,"Invalid canvas. No canvas captured."],[104,"Invalid argument. Argument must be a string."],[105,"Invalid argument. Argument must be a function."],[106,"Invalid ID. No object found with that ID."],[107,"Missing props. Custom objects requires a 'draw' property."],[108,"Invalid props. 'draw' must be a function."],[109,"Missing props. Objects requires a 'type' property."],[110,"Missing props. Image objects requires a 'url' property."],[111,"Updating props declined. 'id' cannot be updated."],[112,"Updating props declined. 'type' cannot be updated."],[113,"Invalid initalize props. 'defaultValues' must be an object."],[114,"Missing props. Text objects requires a 'text' property."],[115,"Missing props. Path objects requires a 'path' property."],]);export default class t{objects=new Map;images=new Map;defaultValues=new Map([["x",0],["y",0],["fill","black"],["stroke",{fill:"black",width:0},],["font",{family:"sans-serif",size:10},],["width",0],["height",0],["borderRadius",0],["rotation","black"],["opacity",1],["zIndex",0],["translate",{x:0,y:0}],]);canvas;ctx;touch=null;constructor(t,e){if(!(t instanceof HTMLElement)&&"string"!=typeof t)throw Error(errorCodes.get(103));if(e&&e.defaultValues){if("object"!=typeof e.defaultValues)throw Error(errorCodes.get(113));Object.entries(e.defaultValues).forEach(([t,e])=>{this.defaultValues.set(t,e)})}this.canvas="string"==typeof t?document.querySelector(t):t,this.ctx=this.canvas.getContext("2d")}createObject(t){if("object"!=typeof t)throw Error(errorCodes.get(101));let{id:e,...s}=t;if(null==e)throw Error(errorCodes.get(100));if("path"===s.type&&s.path){let{width:r,height:i}=getPathProps(s.path);s.width=r,s.height=i}if(this.objects.set(e,s),"image"===s.type){if(!s.url)throw Error(errorCodes.get(110));let o=new Image;o.src=s.url,o.onload=()=>{this.images.set(e,o),drawCanvas(this.canvas,this.objects,this.ctx,this.images,this.defaultValues)}}else drawCanvas(this.canvas,this.objects,this.ctx,this.images,this.defaultValues)}getObject(t){if(null==t)throw Error(errorCodes.get(100));let e=this.objects.get(t);if(!e)throw Error(errorCodes.get(106));return e}updateObject(t,e){if(null==t)throw Error(errorCodes.get(100));if("object"!=typeof e)throw Error(errorCodes.get(101));let s=this.objects.get(t);if(!s)throw Error(errorCodes.get(106));let r=!1;if(Object.entries(e).forEach(([t,e])=>{if("id"===t)throw Error(errorCodes.get(111));if("type"===t)throw Error(errorCodes.get(112));if("url"===t&&(r=!0),"path"===t&&"path"===s.type){let{width:i,height:o}=getPathProps(e);s.width=i,s.height=o}s[t]=e}),"image"===s.type&&r){if(!s.url)throw Error(errorCodes.get(110));let i=new Image;i.src=s.url,i.onload=()=>{this.images.set(t,i),drawCanvas(this.canvas,this.objects,this.ctx,this.images,this.defaultValues)}}else drawCanvas(this.canvas,this.objects,this.ctx,this.images,this.defaultValues)}deleteObject(t){this.objects.delete(t),this.images.delete(t),drawCanvas(this.canvas,this.objects,this.ctx,this.images,this.defaultValues)}moveObject(t,e,s,r){let i=this.objects.get(t);if(!i)throw Error(errorCodes.get(106));"path"===i.type?i.translate?"relative"===r?(i.translate.x+=e,i.translate.y+=s):(i.translate.x=e,i.translate.y=s):i.translate={x:e,y:s}:"relative"===r?(i.x+=(i.x??0)+e,i.y+=(i.y??0)+s):(i.x=e,i.y=s),drawCanvas(this.canvas,this.objects,this.ctx,this.images,this.defaultValues)}getObjects(){return sortByZIndex(this.objects.entries(),this.defaultValues).map(([t,e])=>({id:t,...e}))}setObjects(t){if(!Array.isArray(t)||t.some(t=>"object"!=typeof t))throw Error(errorCodes.get(102));let e=[];t.forEach(t=>{let{id:s,...r}=t;if(null==s)throw Error(errorCodes.get(100));if("path"===r.type&&r.path){let{width:i,height:o}=getPathProps(r.path);r.width=i,r.height=o}if("image"===r.type){if(!r.url)throw Error(errorCodes.get(110));let a=new Image;a.src=r.url;let l=new Promise(t=>{a.onload=()=>{this.images.set(s,a),t()}});e.push(l)}this.objects.set(s,r)}),0===e.length?drawCanvas(this.canvas,this.objects,this.ctx,this.images,this.defaultValues):Promise.all(e).then(()=>{drawCanvas(this.canvas,this.objects,this.ctx,this.images,this.defaultValues)})}clearCanvas(){if(!this.canvas)throw Error(errorCodes.get(103));this.objects.clear(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}on(t,e){if("string"!=typeof t)throw Error(errorCodes.get(104));if("function"!=typeof e)throw Error(errorCodes.get(105));if(!this.canvas)throw Error(errorCodes.get(103));let s=s=>{s.objects=sortByZIndex(this.objects.entries(),this.defaultValues).filter(([,{x:e,y:r,translate:i,width:o,height:a,type:l,text:n}])=>{let h,c;if(t.startsWith("touch")){if("touchstart"===t&&null===this.touch&&(this.touch=s.touches[0].identifier),i&&(e=(i.x??0)+(e??0),r=(i.y??0)+(r??0)),"touchend"===t){if(this.touch!==s.changedTouches[0].identifier)return;h=s.changedTouches[0].clientX,c=s.changedTouches[0].clientY,this.touch=null}else{if(this.touch!==s.changedTouches[0].identifier)return;h=s.touches[0].clientX,c=s.touches[0].clientY}}else h=s.offsetX,c=s.offsetY;if("text"===l){let d=this.ctx.measureText(n);o=d.width,a=d.actualBoundingBoxAscent+d.actualBoundingBoxDescent}else if("circle"===l)return h>=e-o/2&&h<=e+o/2&&c>=r-a/2&&c<=r+a/2;return h>=e&&h<=e+o&&c>=r&&c<=r+a}).reverse().map(([t,e])=>({id:t,...e})),e(s)};return this.canvas.addEventListener(t,s),()=>{this.canvas.removeEventListener(t,s)}}};function drawCanvas(t,e,s,r,i){if(!t)throw Error(errorCodes.get(103));s.setTransform(1,0,0,1,0,0),s.clearRect(0,0,t.width,t.height),sortByZIndex(e.entries(),i).forEach(([e,o])=>{s.setTransform(1,0,0,1,0,0);let a=o.type||i.get("type"),l=o.x??i.get("x"),n=o.y??i.get("y"),h=o.text??i.get("text");if(s.fillStyle=o.fill||i.get("fill"),s.strokeStyle=o.stroke?.fill||i.get("stroke").fill,s.lineWidth=o.stroke?.width??i.get("stroke").width,s.globalAlpha=o.stroke?.opacity??i.get("opacity"),!a)throw Error(errorCodes.get(109));if("text"===a){if(null==h)throw Error(errorCodes.get(114));let c=o.font?.size??i.get("font").size,d=o.font?.family||i.get("font").family;s.textBaseline="top",s.font=`${c}px ${d}`,s.fillText(h,l,n),o.stroke&&o.stroke.width&&o.stroke.fill&&s.strokeText(h,l,n)}else{let g=o.width??i.get("width"),f=o.height??i.get("height"),u=o.borderRadius??i.get("borderRadius"),p=o.translate??i.get("translate"),$=o.rotation??i.get("rotation");if($&&(s.translate(l,n),s.rotate($),s.translate(-l,-n)),p&&(p.x||p.y)&&s.translate(p.x,p.y),"custom"===a){let{draw:w,..._}=o;if(!w)throw Error(errorCodes.get(107));if("function"!=typeof w)throw Error(errorCodes.get(108));w(s,t,_)}else if("image"===a){let b=r.get(e)||i.get("image");if(!b)return;s.drawImage(b,l,n,g,f)}else if("path"===a){s.beginPath();let y=o.path||i.get("path");if(!y)throw Error(errorCodes.get(115));let v=new Path2D(y);s.fill(v),o.stroke&&o.stroke.width&&o.stroke.fill&&s.stroke(v),s.closePath()}else"rectangle"===a?(s.beginPath(),s.moveTo(l+u,n),s.lineTo(l+g-u,n),s.arcTo(l+g,n,l+g,n+u,u),s.lineTo(l+g,n+f-u),s.arcTo(l+g,n+f,l+g-u,n+f,u),s.lineTo(l+u,n+f),s.arcTo(l,n+f,l,n+f-u,u),s.lineTo(l,n+u),s.arcTo(l,n,l+u,n,u),s.fill(),o.stroke&&o.stroke.width&&o.stroke.fill&&s.stroke(),s.closePath()):"triangle"===a?(s.beginPath(),s.moveTo(l+u,n),s.arcTo(l+g,n,l+g,n+f,u),s.arcTo(l+g,n+f,l,n+f,u),s.lineTo(l,n+u),s.arcTo(l,n,l+u,n,u),s.fill(),o.stroke&&o.stroke.width&&o.stroke.fill&&s.stroke(),s.closePath()):"circle"===a&&(s.beginPath(),s.ellipse(l,n,g/2,f/2,0,0,2*Math.PI),s.fill(),o.stroke&&o.stroke.width&&o.stroke.fill&&s.stroke(),s.closePath())}})}function sortByZIndex(t,e){return[...t].sort(([,t],[,s])=>{let r=t.zIndex??e.get("zIndex"),i=s.zIndex??e.get("zIndex");return void 0===r&&void 0===i?0:void 0===r&&i>0?-1:void 0===i&&r>0?1:r-i})}function getPathProps(t){let e=document.createElementNS("http://www.w3.org/2000/svg","svg"),s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d",t),e.appendChild(s),document.body.appendChild(e);let{width:r,height:i}=s.getBoundingClientRect();return document.body.removeChild(e),{width:r,height:i}}